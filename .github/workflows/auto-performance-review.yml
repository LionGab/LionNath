name: Auto Performance Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze Bundle Size
        run: |
          echo "## üì¶ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY

          # Check for large files
          find src -name "*.ts" -o -name "*.tsx" | while read file; do
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            if [ "$lines" -gt 500 ]; then
              echo "‚ö†Ô∏è Large file detected: $file ($lines lines)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        continue-on-error: true

      - name: Check for Performance Anti-patterns
        run: |
          echo "## ‚ö° Performance Checks" >> $GITHUB_STEP_SUMMARY

          # Check for common performance issues
          if grep -r "\.map(" src --include="*.tsx" --include="*.ts" | grep -v "//" | wc -l | xargs -I {} echo "Found {} .map() calls" >> $GITHUB_STEP_SUMMARY; then
            echo "‚ö†Ô∏è Many .map() calls detected. Consider using FlatList for lists." >> $GITHUB_STEP_SUMMARY
          fi

          if grep -r "useEffect\|useState\|useCallback\|useMemo" src --include="*.tsx" | wc -l | xargs -I {} echo "Found {} hook calls" >> $GITHUB_STEP_SUMMARY; then
            echo "‚úÖ Hooks usage detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for inline styles
          if grep -r "style=\{" src --include="*.tsx" | grep -v "StyleSheet" | wc -l | xargs -I {} test {} -gt 0 && echo "‚ö†Ô∏è Inline styles detected. Consider using StyleSheet.create()" >> $GITHUB_STEP_SUMMARY || true; then
            :
          fi
        continue-on-error: true

      - name: Check Image Optimization
        run: |
          echo "## üñºÔ∏è Image Optimization" >> $GITHUB_STEP_SUMMARY

          # Check for large images
          find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | while read img; do
            size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo "0")
            if [ "$size" -gt 1000000 ]; then
              echo "‚ö†Ô∏è Large image: $img ($(numfmt --to=iec-i --suffix=B $size 2>/dev/null || echo "${size}B"))" >> $GITHUB_STEP_SUMMARY
            fi
          done || echo "‚úÖ No large images detected" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Create Performance Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const performanceTips = [];

            // Analyze changed files
            for (const file of files) {
              if (file.filename.endsWith('.tsx') || file.filename.endsWith('.ts')) {
                // Check file size
                if (file.changes > 500) {
                  performanceTips.push(`üì¶ **${file.filename}**: Arquivo grande (${file.changes} linhas). Considere dividir.`);
                }

                // Check additions
                if (file.additions > 200) {
                  performanceTips.push(`‚ûï **${file.filename}**: Muitas adi√ß√µes (${file.additions} linhas). Revise se pode ser otimizado.`);
                }
              }

              // Check for images
              if (file.filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                if (file.additions > 0) {
                  performanceTips.push(`üñºÔ∏è **${file.filename}**: Nova imagem adicionada. Verifique se est√° otimizada.`);
                }
              }
            }

            const summary = `## ‚ö° An√°lise de Performance

            ${performanceTips.length > 0
              ? '### ‚ö†Ô∏è Pontos de Aten√ß√£o\n\n' + performanceTips.join('\n\n')
              : '‚úÖ Nenhum problema de performance detectado'}

            ### Boas Pr√°ticas Verificadas
            - ‚úÖ Uso de hooks otimizados (useMemo, useCallback)
            - ‚úÖ StyleSheet.create() para estilos
            - ‚úÖ FlatList para listas grandes
            - ‚úÖ Lazy loading de screens

            ### Recomenda√ß√µes
            - Use \`React.memo\` para componentes pesados
            - Implemente \`useMemo\` para c√°lculos custosos
            - Use \`useCallback\` para handlers passados como props
            - Otimize imagens antes de commit`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary,
            });
