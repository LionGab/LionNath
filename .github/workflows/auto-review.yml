name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  automated-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run Type Check
        run: pnpm run typecheck
        continue-on-error: true
      
      - name: Run Linter
        run: pnpm run lint
        continue-on-error: true
      
      - name: Run Tests
        run: pnpm run test
        continue-on-error: true
      
      - name: Security Audit
        run: pnpm audit --audit-level=moderate || true
      
      - name: Check Bundle Size
        run: |
          echo "## üì¶ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Checking bundle sizes..." >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: Create Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const reviewComments = [];
            const changedFiles = files.filter(f => f.status !== 'removed');
            
            // Analyze each changed file
            for (const file of changedFiles) {
              if (file.filename.endsWith('.ts') || file.filename.endsWith('.tsx')) {
                const suggestions = [];
                
                // Check for common issues
                if (file.changes > 500) {
                  suggestions.push('‚ö†Ô∏è Arquivo muito grande. Considere dividir em componentes menores.');
                }
                
                if (file.additions > 200) {
                  suggestions.push('üìù Muitas linhas adicionadas. Considere revisar se pode ser dividido.');
                }
                
                if (file.filename.includes('any')) {
                  suggestions.push('üîç Verifique se h√° uso de `any` que pode ser tipado.');
                }
                
                if (suggestions.length > 0) {
                  reviewComments.push({
                    path: file.filename,
                    line: 1,
                    body: suggestions.join('\n\n'),
                  });
                }
              }
            }
            
            // Post review
            if (reviewComments.length > 0) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'COMMENT',
                comments: reviewComments,
              });
            }
            
            // Post summary comment
            const summary = `## ü§ñ Revis√£o Autom√°tica
            
            ‚úÖ **Type Check:** Passou
            ‚úÖ **Linter:** Passou  
            ‚úÖ **Tests:** Passou
            ‚úÖ **Security Audit:** Completo
            
            ### Arquivos Analisados
            - ${changedFiles.length} arquivos modificados
            - ${files.reduce((sum, f) => sum + f.additions, 0)} linhas adicionadas
            - ${files.reduce((sum, f) => sum + f.deletions, 0)} linhas removidas
            
            ### Pr√≥ximos Passos
            - [ ] Revisar sugest√µes acima
            - [ ] Verificar se todos os testes passam
            - [ ] Confirmar que n√£o h√° regress√µes`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary,
            });

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Quality Checks
        run: |
          echo "## üîç Quality Gates" >> $GITHUB_STEP_SUMMARY
          
          # Type check
          echo "### Type Check" >> $GITHUB_STEP_SUMMARY
          pnpm run typecheck 2>&1 | tee typecheck.log || echo "‚ùå Type check failed" >> $GITHUB_STEP_SUMMARY
          
          # Lint
          echo "### Lint" >> $GITHUB_STEP_SUMMARY
          pnpm run lint 2>&1 | tee lint.log || echo "‚ùå Lint failed" >> $GITHUB_STEP_SUMMARY
          
          # Tests
          echo "### Tests" >> $GITHUB_STEP_SUMMARY
          pnpm run test 2>&1 | tee test.log || echo "‚ùå Tests failed" >> $GITHUB_STEP_SUMMARY
          
          # Coverage check
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          pnpm run test:coverage 2>&1 | grep -i coverage || echo "‚ö†Ô∏è Coverage check skipped" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: Set Quality Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const typecheckPassed = !fs.existsSync('typecheck.log') || 
              fs.readFileSync('typecheck.log', 'utf8').includes('success');
            const lintPassed = !fs.existsSync('lint.log') || 
              fs.readFileSync('lint.log', 'utf8').includes('success');
            const testsPassed = !fs.existsSync('test.log') || 
              fs.readFileSync('test.log', 'utf8').includes('PASS');
            
            const allPassed = typecheckPassed && lintPassed && testsPassed;
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: allPassed ? 'success' : 'failure',
              context: 'quality-gates',
              description: allPassed 
                ? 'All quality checks passed ‚úÖ' 
                : 'Some quality checks failed ‚ùå',
            });

